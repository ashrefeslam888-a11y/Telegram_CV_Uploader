import telegram
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, ContextTypes
import requests
import smtplib
from email.mime.text import MIMEText
from datetime import datetime
import os

# =========================================================
# ====== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Final Configuration) ======
# =========================================================
TELEGRAM_BOT_TOKEN = "8185987434:AAEPy_lfozVG5jKdJAybCtzW43CSMGPOPZY"
GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbz9BlKaCGsXndSPpabYM4mc3ldhZLd2nQJvi-vJQdH09mL_428sIcsfv8fuKn5ljJOEQw/exec" 

# ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======
# ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø¨ÙˆØª Ø¹Ø¶ÙˆÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø±ÙˆØ¨. (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ù„Ø¨ ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Channel/Supergroup ID)
HR_GROUP_CHAT_ID = -1001550993072 # ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Øµ Ø¥Ù„Ù‰ ID Ù„Ø¬Ø±ÙˆØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
HR_EMAIL_NOTIFY = "ashref.eslam888@gmail.com" # Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù€ HR/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
EMAIL_SENDER = "YOUR_SENDER_EMAIL@gmail.com" # Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ (ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØªØ·Ø¨ÙŠÙ‚)
EMAIL_PASSWORD = "YOUR_APP_PASSWORD" # ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ÙˆÙ„ÙŠØ³ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©)

# ====== ØªØ¹Ø±ÙŠÙ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ======
REC_NAME, CAND_NAME, FILE_UPLOAD = range(3)

# =========================================================
# Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
# =========================================================

async def send_telegram_notification(context: ContextTypes.DEFAULT_TYPE, message: str):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ø¬Ø±ÙˆØ¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…."""
    try:
        await context.bot.send_message(chat_id=HR_GROUP_CHAT_ID, text=message, parse_mode='Markdown')
    except Exception as e:
        print(f"Error sending Telegram notification: {e}")

def send_email_notification(subject: str, body: str, to_email: str):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (ÙŠØªØ·Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Gmail SMTP)."""
    try:
        msg = MIMEText(body, 'html', 'utf-8')
        msg['Subject'] = subject
        msg['From'] = EMAIL_SENDER
        msg['To'] = to_email

        # Ø§Ø³ØªØ®Ø¯Ø§Ù… SMTP Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Gmail (ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚" Ù„Ø­Ø³Ø§Ø¨Ùƒ)
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            server.login(EMAIL_SENDER, EMAIL_PASSWORD)
            server.sendmail(EMAIL_SENDER, [to_email], msg.as_string())
        return True
    except Exception as e:
        print(f"Error sending email: {e}")
        return False

# =========================================================
# Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google API (Ù„Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„ØªØ­Ù‚Ù‚)
# =========================================================

# (Ø¯Ø§Ù„Ø© api_check_duplicate Ùˆ api_save_data ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§)
def api_check_duplicate(candidate_name, file_name):
    # ... (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    try:
        payload = {
            "action": "Check_Duplicate",
            "candidate_name": candidate_name,
            "file_name": file_name
        }
        response = requests.post(GOOGLE_API_URL, json=payload)
        
        if response.status_code == 200:
            result = response.json()
            return result.get('is_duplicate', True)
        else:
            print(f"API Error: Status {response.status_code}")
            return True
    except Exception as e:
        print(f"Exception in API Check: {e}")
        return True

def api_save_data(data):
    # ... (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    try:
        payload = {
            "action": "Save_Data",
            "recruiter_name": data.get('recruiter_name'),
            "candidate_name": data.get('candidate_name'),
            "file_name": data.get('file_name'),
            "file_link": data.get('file_link'),
            "status": data.get('status')
        }
        response = requests.post(GOOGLE_API_URL, json=payload)
        
        if response.status_code == 200:
            return response.json().get('status') == 'Success'
        return False
    except Exception as e:
        print(f"Exception in API Save: {e}")
        return False

# =========================================================
# Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (Handlers)
# =========================================================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # ... (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    context.user_data['recruiter_name'] = None
    context.user_data['candidate_name'] = None
    welcome_msg = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ø±ÙŠÙƒØ±ÙˆØªØ± ğŸ‘‹.\n" + \
                  "Ù„Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ù„ÙŠ **Ø§Ø³Ù…Ùƒ** (Recruiter Name)."
    await update.message.reply_text(welcome_msg, parse_mode='Markdown')
    return REC_NAME

async def get_recruiter_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # ... (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    recruiter_name = update.message.text
    context.user_data['recruiter_name'] = recruiter_name
    await update.message.reply_text(f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ ÙŠØ§ **{recruiter_name}**.\n" +
                                     "Ø§Ù„Ø¢Ù†ØŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ù„ÙŠ **Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø­** ÙƒØ§Ù…Ù„Ø§Ù‹ (Candidate Name).", 
                                     parse_mode='Markdown')
    return CAND_NAME

async def get_candidate_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # ... (Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ) ...
    candidate_name = update.message.text
    context.user_data['candidate_name'] = candidate_name
    await update.message.reply_text(f"Ù…Ù…ØªØ§Ø²! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø´Ø­: **{candidate_name}**.\n" +
                                     "Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: **Ø£Ø±Ø¬Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© (CV) Ø¨ØµÙŠØºØ© PDF Ø£Ùˆ DOCX.**", 
                                     parse_mode='Markdown')
    return FILE_UPLOAD

async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ù„ÙØŒ ÙŠØ®Ø²Ù†Ù‡ØŒ ÙˆÙŠØ±Ø³Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª."""
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if not update.message.document:
        await update.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø£Ø±Ø¬Ùˆ Ø±ÙØ¹ **Ù…Ù„Ù** CV Ø¨ØµÙŠØºØ© PDF Ø£Ùˆ DOCX.")
        return FILE_UPLOAD

    file_document = update.message.document
    if 'pdf' not in file_document.mime_type and 'word' not in file_document.mime_type:
        await update.message.reply_text("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù†Ø­Ù† Ù†Ù‚Ø¨Ù„ ÙÙ‚Ø· Ù…Ù„ÙØ§Øª PDF Ø£Ùˆ DOCX.")
        return FILE_UPLOAD
        
    await update.message.reply_text("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.")
    
    file_id = file_document.file_id
    file_obj = await context.bot.get_file(file_id)
    file_link = file_obj.file_path 
    
    recruiter_name = context.user_data.get('recruiter_name', 'N/A')
    candidate_name = context.user_data.get('candidate_name', 'N/A')
    file_name = file_document.file_name
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
    is_duplicate = api_check_duplicate(candidate_name, file_name)
    status = "Duplicate" if is_duplicate else "New"
    
    data_to_save = {
        'recruiter_name': recruiter_name,
        'candidate_name': candidate_name,
        'file_name': file_name,
        'file_link': file_link,
        'status': status
    }
    
    save_success = api_save_data(data_to_save)
    
    # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if save_success:
        if status == "New":
            response = "âœ… **Successfully Processed** / ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ© Ø¨Ù†Ø¬Ø§Ø­.\n" \
                       f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ ÙŠØ§ {recruiter_name}ØŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ CV Ø§Ù„Ù…Ø±Ø´Ø­ {candidate_name}."